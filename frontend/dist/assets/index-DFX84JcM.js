import{aZ as E,aS as p,a0 as _,s as m,b7 as P,$ as z,aj as U,bA as J,G as W,bB as O,f as R,L as N,c as K,bu as V,x as X,b4 as Z,v as j,a1 as H,d as tt,bC as et,bD as T,bE as nt,bz as st,bF as rt,bG as ot,bH as it,bI as at,bJ as ct,a3 as lt,bf as ut,ai as dt,bK as pt,ab as ft,bt as gt,ae as ht}from"./browsertracing-Cpaz763f.js";function mt(r,e={}){const s=r.method&&r.method.toUpperCase();let t="",i="url";e.customRoute||r.route?(t=e.customRoute||`${r.baseUrl||""}${r.route&&r.route.path}`,i="route"):(r.originalUrl||r.url)&&(t=E(r.originalUrl||r.url||""));let a="";return e.method&&s&&(a+=s),e.method&&e.path&&(a+=" "),e.path&&t&&(a+=t),[a,i]}function x(r){const e=p([r,"call",t=>t(),"access",t=>t.getClient,"call",t=>t(),"optionalAccess",t=>t.getOptions,"call",t=>t()]);return(p([e,"optionalAccess",t=>t.instrumenter])||"sentry")!=="sentry"}class w{static __initStatic(){this.id="Express"}constructor(e={}){this.name=w.id,this._router=e.router||e.app,this._methods=(Array.isArray(e.methods)?e.methods:[]).concat("use")}setupOnce(e,s){if(!this._router){_&&m.error("ExpressIntegration is missing an Express instance");return}if(x(s)){_&&m.log("Express Integration is skipped because of instrumenter configuration.");return}At(this._router,this._methods),bt(this._router)}}w.__initStatic();function G(r,e){const s=r.length;switch(s){case 2:return function(t,i){const a=i.__sentry_transaction;if(a){const c=a.startChild({description:r.name,op:`middleware.express.${e}`,origin:"auto.middleware.express"});i.once("finish",()=>{c.end()})}return r.call(this,t,i)};case 3:return function(t,i,a){const c=i.__sentry_transaction,u=p([c,"optionalAccess",n=>n.startChild,"call",n=>n({description:r.name,op:`middleware.express.${e}`,origin:"auto.middleware.express"})]);r.call(this,t,i,function(...n){p([u,"optionalAccess",o=>o.end,"call",o=>o()]),a.call(this,...n)})};case 4:return function(t,i,a,c){const u=a.__sentry_transaction,n=p([u,"optionalAccess",o=>o.startChild,"call",o=>o({description:r.name,op:`middleware.express.${e}`,origin:"auto.middleware.express"})]);r.call(this,t,i,a,function(...o){p([n,"optionalAccess",l=>l.end,"call",l=>l()]),c.call(this,...o)})};default:throw new Error(`Express middleware takes 2-4 arguments. Got: ${s}`)}}function _t(r,e){return r.map(s=>typeof s=="function"?G(s,e):Array.isArray(s)?s.map(t=>typeof t=="function"?G(t,e):t):s)}function yt(r,e){const s=r[e];return r[e]=function(...t){return s.call(this,..._t(t,e))},r}function At(r,e=[]){e.forEach(s=>yt(r,s))}function bt(r){const e="settings"in r;e&&r._router===void 0&&r.lazyrouter&&r.lazyrouter();const s=e?r._router:r;if(!s){_&&m.debug("Cannot instrument router for URL Parameterization (did not find a valid router)."),_&&m.debug("Routing instrumentation is currently only supported in Express 4.");return}const t=Object.getPrototypeOf(s),i=t.process_params;t.process_params=function(c,u,n,o,l){n._reconstructedRoute||(n._reconstructedRoute="");const{layerRoutePath:h,isRegex:y,isArray:A,numExtraSegments:d}=Rt(c);(h||y||A)&&(n._hasParameters=!0);let g;h?g=h:g=It(n.originalUrl,n._reconstructedRoute,c.path)||"";const f=g.split("/").filter(S=>S.length>0&&(y||A||!S.includes("*"))).join("/");f&&f.length>0&&(n._reconstructedRoute+=`/${f}${y?"/":""}`);const b=P(E(n.originalUrl||""))+d,I=P(n._reconstructedRoute);if(b===I){n._hasParameters||n._reconstructedRoute!==n.originalUrl&&(n._reconstructedRoute=n.originalUrl?E(n.originalUrl):n.originalUrl);const S=o.__sentry_transaction,B=S&&z(S).data||{};if(S&&B[U]!=="custom"){const F=n._reconstructedRoute||"/",[Q,Y]=mt(n,{path:!0,method:!0,customRoute:F});S.updateName(Q),S.setAttribute(U,Y)}}return i.call(this,c,u,n,o,l)}}const St=(r,e,s)=>{if(!r||!e||!s||Object.keys(s).length===0||p([s,"access",o=>o[0],"optionalAccess",o=>o.offset])===void 0||p([s,"access",o=>o[0],"optionalAccess",o=>o.offset])===null)return;const t=s.sort((o,l)=>o.offset-l.offset),a=new RegExp(e,`${e.flags}d`).exec(r);if(!a||!a.indices)return;const[,...c]=a.indices;if(c.length!==t.length)return;let u=r,n=0;return c.forEach((o,l)=>{if(o){const[h,y]=o,A=u.substring(0,h-n),d=`:${t[l].name}`,g=u.substring(y-n);u=A+d+g,n=n+(y-h-d.length)}}),u};function Rt(r){let e=p([r,"access",c=>c.route,"optionalAccess",c=>c.path]);const s=J(e),t=Array.isArray(e);if(!e){const[c]=W.process.versions.node.split(".").map(Number);c>=16&&(e=St(r.path,r.regexp,r.keys))}if(!e)return{isRegex:s,isArray:t,numExtraSegments:0};const i=t?Math.max(Ot(e)-P(r.path||""),0):0;return{layerRoutePath:xt(t,e),isRegex:s,isArray:t,numExtraSegments:i}}function Ot(r){return r.reduce((e,s)=>e+P(s.toString()),0)}function xt(r,e){return r?e.map(s=>s.toString()).join(","):e&&e.toString()}function It(r,e,s){const t=E(r||""),i=p([t,"optionalAccess",n=>n.split,"call",n=>n("/"),"access",n=>n.filter,"call",n=>n(o=>!!o)]);let a=0;const c=p([e,"optionalAccess",n=>n.split,"call",n=>n("/"),"access",n=>n.filter,"call",n=>n(o=>!!o),"access",n=>n.length])||0;return p([s,"optionalAccess",n=>n.split,"call",n=>n("/"),"access",n=>n.filter,"call",n=>n(o=>p([i,"optionalAccess",l=>l[c+a]])===o?(a+=1,!0):!1),"access",n=>n.join,"call",n=>n("/")])}class C{static __initStatic(){this.id="Postgres"}constructor(e={}){this.name=C.id,this._usePgNative=!!e.usePgNative,this._module=e.module}loadDependency(){return this._module=this._module||O("pg")}setupOnce(e,s){if(x(s)){_&&m.log("Postgres Integration is skipped because of instrumenter configuration.");return}const t=this.loadDependency();if(!t){_&&m.error("Postgres Integration was unable to require `pg` package.");return}const i=this._usePgNative?p([t,"access",a=>a.native,"optionalAccess",a=>a.Client]):t.Client;if(!i){_&&m.error("Postgres Integration was unable to access 'pg-native' bindings.");return}R(i.prototype,"query",function(a){return function(c,u,n){const l=s().getScope().getSpan(),h={"db.system":"postgresql"};try{this.database&&(h["db.name"]=this.database),this.host&&(h["server.address"]=this.host),this.port&&(h["server.port"]=this.port),this.user&&(h["db.user"]=this.user)}catch{}const y=p([l,"optionalAccess",d=>d.startChild,"call",d=>d({description:typeof c=="string"?c:c.text,op:"db",origin:"auto.db.postgres",data:h})]);if(typeof n=="function")return a.call(this,c,u,function(d,g){p([y,"optionalAccess",f=>f.end,"call",f=>f()]),n(d,g)});if(typeof u=="function")return a.call(this,c,function(d,g){p([y,"optionalAccess",f=>f.end,"call",f=>f()]),u(d,g)});const A=typeof u<"u"?a.call(this,c,u):a.call(this,c);return N(A)?A.then(d=>(p([y,"optionalAccess",g=>g.end,"call",g=>g()]),d)):(p([y,"optionalAccess",d=>d.end,"call",d=>d()]),A)}})}}C.__initStatic();class ${static __initStatic(){this.id="Mysql"}constructor(){this.name=$.id}loadDependency(){return this._module=this._module||O("mysql/lib/Connection.js")}setupOnce(e,s){if(x(s)){_&&m.log("Mysql Integration is skipped because of instrumenter configuration.");return}const t=this.loadDependency();if(!t){_&&m.error("Mysql Integration was unable to require `mysql` package.");return}let i;try{t.prototype.connect=new Proxy(t.prototype.connect,{apply(u,n,o){return i||(i=n.config),u.apply(n,o)}})}catch{_&&m.error("Mysql Integration was unable to instrument `mysql` config.")}function a(){return i?{"server.address":i.host,"server.port":i.port,"db.user":i.user}:{}}function c(u){if(!u)return;const n=a();Object.keys(n).forEach(o=>{u.setAttribute(o,n[o])}),u.end()}R(t,"createQuery",function(u){return function(n,o,l){const y=s().getScope().getSpan(),A=p([y,"optionalAccess",g=>g.startChild,"call",g=>g({description:typeof n=="string"?n:n.sql,op:"db",origin:"auto.db.mysql",data:{"db.system":"mysql"}})]);if(typeof l=="function")return u.call(this,n,o,function(g,f,b){c(A),l(g,f,b)});if(typeof o=="function")return u.call(this,n,function(g,f,b){c(A),o(g,f,b)});const d=u.call(this,n,o);return d.on("end",()=>{c(A)}),d}})}}$.__initStatic();const Et=["aggregate","bulkWrite","countDocuments","createIndex","createIndexes","deleteMany","deleteOne","distinct","drop","dropIndex","dropIndexes","estimatedDocumentCount","find","findOne","findOneAndDelete","findOneAndReplace","findOneAndUpdate","indexes","indexExists","indexInformation","initializeOrderedBulkOp","insertMany","insertOne","isCapped","mapReduce","options","parallelCollectionScan","rename","replaceOne","stats","updateMany","updateOne"],Tt={bulkWrite:["operations"],countDocuments:["query"],createIndex:["fieldOrSpec"],createIndexes:["indexSpecs"],deleteMany:["filter"],deleteOne:["filter"],distinct:["key","query"],dropIndex:["indexName"],find:["query"],findOne:["query"],findOneAndDelete:["filter"],findOneAndReplace:["filter","replacement"],findOneAndUpdate:["filter","update"],indexExists:["indexes"],insertMany:["docs"],insertOne:["doc"],mapReduce:["map","reduce"],rename:["newName"],replaceOne:["filter","doc"],updateMany:["filter","update"],updateOne:["filter","update"]};function Pt(r){return r&&typeof r=="object"&&r.once&&typeof r.once=="function"}class v{static __initStatic(){this.id="Mongo"}constructor(e={}){this.name=v.id,this._operations=Array.isArray(e.operations)?e.operations:Et,this._describeOperations="describeOperations"in e?e.describeOperations:!0,this._useMongoose=!!e.useMongoose}loadDependency(){const e=this._useMongoose?"mongoose":"mongodb";return this._module=this._module||O(e)}setupOnce(e,s){if(x(s)){_&&m.log("Mongo Integration is skipped because of instrumenter configuration.");return}const t=this.loadDependency();if(!t){const i=this._useMongoose?"mongoose":"mongodb";_&&m.error(`Mongo Integration was unable to require \`${i}\` package.`);return}this._instrumentOperations(t.Collection,this._operations,s)}_instrumentOperations(e,s,t){s.forEach(i=>this._patchOperation(e,i,t))}_patchOperation(e,s,t){if(!(s in e.prototype))return;const i=this._getSpanContextFromOperationArguments.bind(this);R(e.prototype,s,function(a){return function(...c){const u=c[c.length-1],n=t(),o=n.getScope(),l=n.getClient(),h=o.getSpan(),y=p([l,"optionalAccess",d=>d.getOptions,"call",d=>d(),"access",d=>d.sendDefaultPii]);if(typeof u!="function"||s==="mapReduce"&&c.length===2){const d=p([h,"optionalAccess",f=>f.startChild,"call",f=>f(i(this,s,c,y))]),g=a.call(this,...c);if(N(g))return g.then(f=>(p([d,"optionalAccess",b=>b.end,"call",b=>b()]),f));if(Pt(g)){const f=g;try{f.once("close",()=>{p([d,"optionalAccess",b=>b.end,"call",b=>b()])})}catch{p([d,"optionalAccess",I=>I.end,"call",I=>I()])}return f}else return p([d,"optionalAccess",f=>f.end,"call",f=>f()]),g}const A=p([h,"optionalAccess",d=>d.startChild,"call",d=>d(i(this,s,c.slice(0,-1)))]);return a.call(this,...c.slice(0,-1),function(d,g){p([A,"optionalAccess",f=>f.end,"call",f=>f()]),u(d,g)})}})}_getSpanContextFromOperationArguments(e,s,t,i=!1){const a={"db.system":"mongodb","db.name":e.dbName,"db.operation":s,"db.mongodb.collection":e.collectionName},c={op:"db",origin:"auto.db.mongo",description:s,data:a},u=Tt[s],n=Array.isArray(this._describeOperations)?this._describeOperations.includes(s):this._describeOperations;if(!u||!n||!i)return c;try{if(s==="mapReduce"){const[o,l]=t;a[u[0]]=typeof o=="string"?o:o.name||"<anonymous>",a[u[1]]=typeof l=="string"?l:l.name||"<anonymous>"}else for(let o=0;o<u.length;o++)a[`db.mongodb.${u[o]}`]=JSON.stringify(t[o])}catch{}return c}}v.__initStatic();function Nt(r){return!!r&&!!r.$use}class M{static __initStatic(){this.id="Prisma"}constructor(e={}){if(this.name=M.id,Nt(e.client)&&!e.client._sentryInstrumented){K(e.client,"_sentryInstrumented",!0);const s={};try{const t=e.client._engineConfig;if(t){const{activeProvider:i,clientVersion:a}=t;i&&(s["db.system"]=i),a&&(s["db.prisma.version"]=a)}}catch{}e.client.$use((t,i)=>{if(x(X))return i(t);const a=t.action,c=t.model;return V({name:c?`${c} ${a}`:a,onlyIfParent:!0,op:"db.prisma",attributes:{[Z]:"auto.db.prisma"},data:{...s,"db.operation":a}},()=>i(t))})}else _&&m.warn("Unsupported Prisma client provided to PrismaIntegration. Provided client:",e.client)}setupOnce(){}}M.__initStatic();class D{static __initStatic(){this.id="GraphQL"}constructor(){this.name=D.id}loadDependency(){return this._module=this._module||O("graphql/execution/execute.js")}setupOnce(e,s){if(x(s)){_&&m.log("GraphQL Integration is skipped because of instrumenter configuration.");return}const t=this.loadDependency();if(!t){_&&m.error("GraphQL Integration was unable to require graphql/execution package.");return}R(t,"execute",function(i){return function(...a){const c=s().getScope(),u=c.getSpan(),n=p([u,"optionalAccess",l=>l.startChild,"call",l=>l({description:"execute",op:"graphql.execute",origin:"auto.graphql.graphql"})]);p([c,"optionalAccess",l=>l.setSpan,"call",l=>l(n)]);const o=i.call(this,...a);return N(o)?o.then(l=>(p([n,"optionalAccess",h=>h.end,"call",h=>h()]),p([c,"optionalAccess",h=>h.setSpan,"call",h=>h(u)]),l)):(p([n,"optionalAccess",l=>l.end,"call",l=>l()]),p([c,"optionalAccess",l=>l.setSpan,"call",l=>l(u)]),o)}})}}D.__initStatic();class k{static __initStatic(){this.id="Apollo"}constructor(e={useNestjs:!1}){this.name=k.id,this._useNest=!!e.useNestjs}loadDependency(){return this._useNest?this._module=this._module||O("@nestjs/graphql"):this._module=this._module||O("apollo-server-core"),this._module}setupOnce(e,s){if(x(s)){_&&m.log("Apollo Integration is skipped because of instrumenter configuration.");return}if(this._useNest){const t=this.loadDependency();if(!t){_&&m.error("Apollo-NestJS Integration was unable to require @nestjs/graphql package.");return}R(t.GraphQLFactory.prototype,"mergeWithSchema",function(i){return function(...a){return R(this.resolversExplorerService,"explore",function(c){return function(){const u=j(c.call(this));return q(u,s)}}),i.call(this,...a)}})}else{const t=this.loadDependency();if(!t){_&&m.error("Apollo Integration was unable to require apollo-server-core package.");return}R(t.ApolloServerBase.prototype,"constructSchema",function(i){return function(){if(!this.config.resolvers)return _&&(this.config.schema?(m.warn("Apollo integration is not able to trace `ApolloServer` instances constructed via `schema` property.If you are using NestJS with Apollo, please use `Sentry.Integrations.Apollo({ useNestjs: true })` instead."),m.warn()):this.config.modules&&m.warn("Apollo integration is not able to trace `ApolloServer` instances constructed via `modules` property."),m.error("Skipping tracing as no resolvers found on the `ApolloServer` instance.")),i.call(this);const a=j(this.config.resolvers);return this.config.resolvers=q(a,s),i.call(this)}})}}}k.__initStatic();function q(r,e){return r.map(s=>(Object.keys(s).forEach(t=>{Object.keys(s[t]).forEach(i=>{typeof s[t][i]=="function"&&wt(s,t,i,e)})}),s))}function wt(r,e,s,t){R(r[e],s,function(i){return function(...a){const u=t().getScope().getSpan(),n=p([u,"optionalAccess",l=>l.startChild,"call",l=>l({description:`${e}.${s}`,op:"graphql.resolve",origin:"auto.graphql.apollo"})]),o=i.call(this,...a);return N(o)?o.then(l=>(p([n,"optionalAccess",h=>h.end,"call",h=>h()]),l)):(p([n,"optionalAccess",l=>l.end,"call",l=>l()]),o)}})}function Ct(){const r=et();if(!r.__SENTRY__)return;const e={mongodb(){const t=T(module,"./node/integrations/mongo");return new t.Mongo},mongoose(){const t=T(module,"./node/integrations/mongo");return new t.Mongo},mysql(){const t=T(module,"./node/integrations/mysql");return new t.Mysql},pg(){const t=T(module,"./node/integrations/postgres");return new t.Postgres}},s=Object.keys(e).filter(t=>!!O(t)).map(t=>{try{return e[t]()}catch{return}}).filter(t=>t);s.length>0&&(r.__SENTRY__.integrations=[...r.__SENTRY__.integrations||[],...s])}function L(){H(),tt()&&Ct()}const $t=st,Mt=L,Dt=dt,kt=ut,Ut=gt,jt=ct,Gt=ot,qt=nt,Lt=lt,Bt=pt,Ft=E,Qt=at,Yt=rt,zt=ft,Jt=ht,Wt=it,Kt={BrowserTracing:$t,Apollo:k,Express:w,GraphQL:D,Mongo:v,Mysql:$,Postgres:C,Prisma:M};(typeof __SENTRY_TRACING__>"u"||__SENTRY_TRACING__)&&L();export{qt as BROWSER_TRACING_INTEGRATION_ID,$t as BrowserTracing,Yt as IdleTransaction,Kt as Integrations,Gt as Span,Wt as SpanStatus,Qt as TRACEPARENT_REGEXP,jt as Transaction,Mt as addExtensionMethods,Lt as defaultRequestInstrumentationOptions,kt as extractTraceparentData,Dt as getActiveTransaction,Bt as hasTracingEnabled,zt as instrumentOutgoingRequests,Ut as spanStatusfromHttpCode,Jt as startIdleTransaction,Ft as stripUrlQueryAndFragment};
